---
{"dg-publish":true,"permalink":"/projects/library/600/630/630-30/630-30-a/","noteIcon":"0","created":"2024-01-30T20:06:19.788+09:00","updated":"2024-02-26T21:13:55.163+09:00"}
---

#[[Projects/Library/600/600\|600]]#ML_Libraries_and_Implementation#[[Projects/Library/600/630/630\|630]]#Machine_Learning_Frameworks#[[Projects/Library/600/630/630.30/630.30\|630.30]]#Langchain#[[Projects/Library/600/630/630.30/630.30 a\|630.30 a]]#Amazon_Bedrock_with_RAG






aws sage maker 개인 root 계정 사용, us-east-1

01 intro boto3 셋업에서 부터 model 호출시 access denined가 발생함
03QuestioinAnswering
```
전부 주석처리 그대로해서 디폴트값 사용
# os.environ["AWS_DEFAULT_REGION"] = "<REGION_NAME>"  # E.g. "us-east-1"
# os.environ["AWS_PROFILE"] = "<YOUR_PROFILE>"
# os.environ["BEDROCK_ASSUME_ROLE"] = "<YOUR_ROLE_ARN>"  # E.g. "arn:aws:..."
```
함수 호출시에 accesdenined
```
try:
    
    sample_embedding = np.array(bedrock_embeddings.embed_query(docs[0].page_content))
    print("Sample embedding of a document chunk: ", sample_embedding)
    print("Size of the embedding: ", sample_embedding.shape)

except ValueError as error:
    if  "AccessDeniedException" in str(error):
        print(f"\x1b[41m{error}\
        \nTo troubeshoot this issue please refer to the following resources.\
         \nhttps://docs.aws.amazon.com/IAM/latest/UserGuide/troubleshoot_access-denied.html\
         \nhttps://docs.aws.amazon.com/bedrock/latest/userguide/security-iam.html\x1b[0m\n")      
        class StopExecution(ValueError):
            def _render_traceback_(self):
                pass
        raise StopExecution        
    else:
        raise error
```

samge maker iam role 확인, 기본 sagemaker user role에bedrock 관련 policy없음.
bedrock fullaccess 부여
->그래도 access 에러




다시보니 맨처음 sagemaker 이미지 관련 data science 3.0이미지조건 언급된 부분 확인
해당 이미지 사용하기위한 ecr 이미지 도메인 탐색. 바로 내 sagemaker 환경에 다운받을 수 있게.
하지만 못찾음

그래서 ecr 만들어서 자체업로드 생각
그래서 sagemaker sdk써봤는데, url를 사용하면 도메인이 나온다는  안나옴

주피터 인스턴스 써보면 어떨까 했는데 랭체인이 안깔려있음


---


해결

가장먼저 console에서 model access관련 허용

로컬에서 사용하고자할 떄 해당 설정 추가

ACCESS_KEY = '' ## aws ACCESS_KEY 입력
SECRET_KEY = 'z4hrViOrMjHXx0XkCOHHJnrm5QhBGFKJrt4bNyzG' ## aws SECRET_KEY 입력

os.environ["AWS_DEFAULT_REGION"] = "us-east-1" 

bedrock_runtime = boto3.client('bedrock-runtime', 
                               region_name = 'us-east-1', 
                               endpoint_url="[https://bedrock-runtime.us-east-1.amazonaws.com](https://bedrock-runtime.us-east-1.amazonaws.com/)",  
                               aws_access_key_id=ACCESS_KEY,
                               aws_secret_access_key=SECRET_KEY,
                               )
titan = 'amazon.titan-embed-text-v1'

bedrock_embeddings = BedrockEmbeddings(model_id=titan,
                                     region_name = 'us-east-1', 
                                     client=bedrock_runtime
                                     )